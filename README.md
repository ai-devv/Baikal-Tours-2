# [Baikal Tours](https://baikal.events)

## Команда
1. Жуков Максим -- frontend,
2. Васильева Полина -- UX/UI designer,
3. Ильюшин Александр -- backend (@pointofvoid).

## Краткое описание проекта
Проект предназначен для агрегирования событий Иркутской области, на Байкале в т.ч., популяризации туризма. Удобный поиск событий, бронирование билетов, система оповещений пользователей через email-рассылку.

## Пользователи и их сценарии
1. Обычный пользователь,
2. Организатор (расширенные возможности обычного пользователя),
3. Администратор (полный доступ к сайту).

Основной сценарий пользователя – выбрать событие и зарегистрироваться на него. Сделать он это может с главной страницы: попав на каталог событий или через «квиз». Квиз – это процесс из двух шагов, который автоматически применит нужные фильтры для пользователя и «перекинет» на страницу каталога событий. В каталоге событий пользователь выбирает непосредственно событие, узнаёт о нём всю информацию и, при желании, регистрируется на него. Зарегистрироваться могут только зарегистрированные на сайте пользователи. Билеты можно оформить на имя, отличное от того, которое указано при регистрации. При оформлении билетов создаётся «бронь», которую можно либо оплатить, либо отменить. Пользователь также может взаимодействовать с личным кабинетом, меняя свои данные, узнавая о неоплаченных бронях и о прошедших и предстоящих событиях. Если пользователь в течение некоторого времени не оплатил билеты, то ему придёт email-уведомление об этом.

Организатор может делать всё то же самое, что и обычный пользователь, но у него в личном кабинете присутствует возможность отслеживать статистику по тем событиям, на которых он отмечен как организатор. Также он имеет возможность выгрузить в файл формата «.xlsx*» некоторую сводку актуальных данных по каждому событию. Вдобавок ко всему, в личном кабинете организатора показывается суммарный баланс по всем событиям. Эти средства доступны ему для «снятия», для этого он может оформить заявку на вывод средств, которую любой администратор может либо отклонить, с некоторой причиной, либо принять.

Администратор же может делать всё, что и обычный пользователь, также наделён теми же возможностями, что и организатор, при условии, что есть события, где он отмечен как таковой. Также у него есть доступ в панель администратора, где он может производить все необходимые действия с сайтом.

## Определения
1. Локации – иерархический трёхуровневый справочник, содержащий в себе перечень всех локаций, которые могут быть использованы в других сущностях. Содержит только название локации. При «прикреплении» локации к событию появляется возможность выставить конкретные координаты и точный адрес с помощью встроенной карты.
2. Тематики – справочник, содержащий в себе перечень всех тематик, которые могут быть прикреплены к событию.
3. Трансферы – справочник, содержащий в себе перечень всех трансферов, которые могут быть прикреплены к событию.
4. Компаньоны – справочник, содержащий в себе перечень названий, которые можно трактовать как «с кем можно пойти на событие?». Т.е., например, «с ребёнком».
5. Событие – сущность, описывающее какое-либо мероприятие (название, описание, локации, фотографии, даты, билеты и т.д.).
6. Билеты события/дополнительные услуги события – конкретные варианты билетов/доп. услуг. Если у события присутствуют билеты то, для участия в событии, необходимо купить хотя бы один билет. Дополнительные услуги не являются обязательными к покупке.
7. Экскурсии/туры – сущности, описывающие, какие есть экскурсии или туры, в каких локациях, за какую цену. Прикрепляются к событиям. Нужны, чтобы пользователь при бронировании билетов мог выбрать куда ещё можно сходить.
8. Отели – сущности, описывающие, какие отели можно использовать для прикрепления к событиям. Нужны, чтобы пользователь при бронировании билетов мог выбрать отель.
9. Подборки – сущность, содержащая в себе перечень событий, где у каждого есть своё описание. У подборки есть локации и тематики. Нужны для объединения событий, допустим, по одной тематике. Пользователю так проще выбрать конкретное событие.
10. Избранные событие – сущность, объединяющая в себе не более 4х событий одной тематики. Также есть избранные события без тематики, максимум 4 штуки.
11. Заявки на выплату средств – у события есть организаторы и баланс. Баланс формируется из оплаченных броней. Каждый организатор может запросить некоторую сумму на вывод, не превышающую текущий баланс события (создать заявку), которая может быть отклонена или принята.
12. Пересечения – на сайте есть каталог событий. В нём можно выбрать несколько фильтров, например, локации, тематики, даты и т.д. Пересечение – это сущность, которая содержит некую информацию для сочетание определённых фильтров. Допустим, пользователь выбирает локацию «Иркутск» и тематику «Спорт». Получается URL «irkutsk_sport». Для такого «пересечения» и задаётся некоторая информация.
13. Авто-перевод – в запросах к серверу есть возможность указывать, какие данные необходимо перевести, с какого языка и на какой. Во всех запросах поддерживается авто-перевод, либо авто-транслитерация текста на указанные языки в запросе. Необходимо для функционирования интернационализации.

## Backend (функциональные возможности)
1. Работа со справочниками (создание/удаление/изменение/чтение локаций, тематик и трансферов).
2. Работа с событиями:
    2.1. Создание/редактирование события (title, короткое описание, полное описание, URL, название, фотографии, выбор главного изображения, создание ALT-тега к главной фотографии, создание дат, проставление локаций, тематик, трансферов, компаньонов, названия организатора, проставление организаторов из справочника пользователей, контактов, соц. сетей, билетов, дополнительных услуг, партнёров события, прикрепления экскурсий, туров и отелей).
    Также, у события есть «статус»: активное, скрытое, в архиве. Если событие «скрытое» или «в архиве», то оно не показывается обычным пользователям при выдаче, не участвует в рассылках, подборках и т.д.
    2.2. Получение множества событий по конкретному языку. Возможность разбиение результата по страницам, фильтрации по дате начала, дате окончания, локациям, компаньонам, тематикам, начальной цене и конечной цене. Возможность поиска по ключевым словам (название и полное описание события). Для администраторов есть возможность получать события с любым статусом.
    2.3. Получение одного события по URL (super-festival-veka).
    2.4. Автоматическое архивирование события по истечению последней даты окончания события.
    2.5. Оформление броней на событие, отмена броней на событие, оплата броней события через Сбербанка (используется платёжный API).
    2.6. Письменное оповещение организаторов в некоторый период времени о том, сколько человек зарегистрировано на событие, какие билеты/доп. услуги куплены/забронированы.
    2.7. Выгрузка подробных данных о купленных/оплаченных билетах и доп. услугах по событию в файл формата «.xlsx». Доступно только для организаторов события.
    2.8. На странице события показываются два ближайших события, которые подходят по датам и тематикам.
3. Работа с пользователями:
    3.1. Регистрация пользователя (имя, фамилия, телефон, email, язык). Пароль создаётся случайным образом и отправляется пользователю письмом. В базу данных сохраняется хеш пароля и соль.
    3.2. Вход пользователя по почте или телефону.
    3.3. Восстановление пароля по почте. Восстановление возможно максимум 4 раза за 30 дней. При восстановлении новый пароль также высылается на почту.
    3.4. Получение пользователей с возможностью поиска по имени, фамилии, телефону и почте. Только для администраторов.
    3.5. Получение/изменение/удаление одного пользователя. Для администратора – любого, для обычного пользователя – только самого себя.
    3.6. Также, администратор может поменять роль пользователя.
    3.7. Получение событий, где пользователь является организатором.
    3.8. Получение всех заявок пользователя на вывод средств.
4. Работа с экскурсиями/турами (т.к., на самом деле, это идентичные сущности):
    4.1. Создание/редактирование (название, сайт, дата начала, дата окончания, локации, цена, изображение).
    4.2. Получение множества сущностей с возможностью фильтрации по дате начала, дате окончания, локациям.
    4.3. Получение одной сущности по id.
    4.4. Сущности можно «привязать» к событию, тогда на странице события они будут показываться. Важно, если у события нет прикреплённых сущностей, тогда сущности получаются автоматически с фильтрацией по локациям события.
5. Работа с отелями:
    5.1. Изначально отели были «спарсены» с сайта booking по определённым критериям, это была изначальная база.
    5.2. Также, из всех локаций всех отелей был составлен справочник локаций отелей (локации букинга).
    5.3. Создание/редактирование (название, ссылка на booking, фотография, цена, рейтинг, локация букинга).
    5.4. Получение множества отелей с возможностью разбиения результата по страницам, фильтрации по локациям и локациям букинга. Возможность поиска по названию отеля.
    5.5. Удаление отеля по id.
    5.6. Прикрепление отеля к событию. Если у события не будет прикреплённых отелей, то они автоматически получатся с сервера с фильтрацией по тем же локациям, что и у события.
6. Работа с подборками:
    6.1. Создание/редактирование подборки (URL, title, название, слоган, описание, локации, тематики, изображение). К каждой подборке можно прикрепить события, задав для каждого из них уникальное описание в рамках подборки.
    6.2. Получение всех подборок с возможностью фильтрации по локациям, тематикам, дате начала и дате окончания.
    6.3. Получение подборки по URL.
    6.4. Удаление подборки по id.
7. Работа с избранными событиями:
    7.1. Создание/редактирование избранных событий по конкретной тематике. Для избранных событий без тематики, соответственно, тематика не нужна. Учитывается порядок элементов.
    7.2. Получение всех избранных событий с возможностью фильтрации по тематикам. Для избранных событий без тематики реализовано получение всех событий.
8. Работа с заявками на выплату:
    8.1. Создание заявки (получатель, банк, номер аккаунта, бик, инн, кпп, сумма). Только для организаторов события.
    Допустим, у организатора 3 события. На одном событии 10000 рублей, на другом 5000 рублей, а на третьем 1000р. Если он запросит вывод средств на 11000 рублей, то сначала будет выбрано первое событие, т.к. у него баланс больше всего, из баланса этого события вычитается 10000 рублей, далее из баланса события, у которого 5000 рублей, вычитается ещё 1000 рублей.
    8.2. Принятие заявки. Подразумевается, что человек лично переводит деньги, а через приложение лишь подтверждает этот факт.
    8.3. Отклонение заявки. Тоже самое, но ещё указывается причина отказа, а также все деньги, зарезервированные для вывода, возвращаются на балансы тех событий, с которых были вычтены.
9. Работа с пересечениями:
    9.1. Создание/редактирование пересечения (slug – часть URL, описание, интро-текст, заголовок, title). Редактирование по id.
    9.2. Получение всех пересечений.
    9.3. Получение одного пересечения по slug.
    9.4. Удаление пересечения по id.
10. Работа с картой сайта (sitemap.txt):
    10.1. Есть возможность сгенерировать карту сайта. Автоматически в неё заносятся следующий ссылки:
        10.1.1. Собственная ссылка
        10.1.2. /events
        10.1.3. Ссылки всех активных событий
        10.1.4. Ссылки всех подборок
        10.1.5. Ссылки всех пересечений
    10.2. Есть возможность подправить руками, дописать что-то.
    10.3. Получить карту сайта.
11. CRON-демон. Был написан для другого проекта и успешно внедрён в этот. Служит для выполнения некоторых задач (периодических и нет) во времени. К примеру: отправка писем раз в месяц, уведомление организаторов события раз в неделю актуальными данными о событии.
Написан таким образом, что сохраняет своё состояние в базе данных, т.е. завершая работу сервера и снова возобновляя её, CRON-демон продолжит функционировать и выполнять ранее сохранённые задачи.
12. Интернационализация – поддержка нескольких языковых версий сайта.
13. Система ролей у пользователей. Необходимо, чтобы «защищать» отдельные части приложения (т.н. «роуты»).
14. Поддержка загрузки файлов. В данном проекте – изображений к разным сущностям.
15. Работа с базой данных «PostgreSQL».
16. Работа с сессиями (использован модуль «express-session» для сохранения пользовательских сессий в базу данных и синхронизации этих данных с запросами на сервере).
17. Почтовый «модуль». Реализована система, при которой письмо делится на три части:
    17.1. Разметка.
    17.2. Шаблон текста с некоторыми вставками «{…}» (например, «Привет, {name}!»).
    17.3. Данные.

Таким образом, сначала мы считываем из файла разметку письма, затем из базы получаем все шаблонные тексты нужных языков, необходимые данные на нужных языках, формируем письма (подставляем шаблонный текст в разметку, данные в шаблонный текст) и затем отправляем их пользователям. Это позволяет достичь гибкости разработки писем, разделения обязанностей и поддержки интернационализации.
18. Написан небольшой «хелпер» для преобразования данных из базы данных. Как мы знаем, данные из базы приходят в виде «плоской» структуры. Но иногда нам хотелось бы достичь вложенности. К примеру, мы хотим получить авторов, а затем все статьи каждого автора, и чтобы в объекте «authors» можно было получить данные следующим образом «authors[0].articles».
19. Написана своя «обёртка» над функцией «fetch» – стандартной функцией из JavaScript. Необходима для того, чтобы гибко управлять параметрами запроса и использовать это как на клиенте, так и на сервере.
20. Написано ещё несколько «малозначительных хелперов», о которых я могу рассказать подробнее, если это требуется.

**В ходе проекты были разработаны некоторые модули, описанные ранее (переводчик, email-сервис, CRON-демон, преобразование данных из базы данных).**

## Frontend (функциональные возможности)
*Add later...*

*P.S.: Наша задача заключалась в обеспечении отказоустойчивости системы, поддержки интернационализации (в т.ч. авто-перевода и авто-транслитерации текстов и интерфейса), проведении пользователя до регистрации на событие и покупки билетов и обеспечении работы email-уведомлений. А также группировки событий в «подборки» и SEO-оптимизации сайта.*
